<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLX - Art Persona</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link href="artPersona.css" rel="stylesheet"> <!-- Link para o arquivo externo de estilo -->
</head>
<body>
  <div class="container">
    <div class="header">MLX - Art Persona</div>
    
    <div class="main-content-wrapper">
      <div class="left-panel col-md-3">
        <div class="user-profile">
          <i class="fas fa-user"></i> Perfil do Usuário: <span id="username">Carregando...</span>
        </div>
        <div class="btn-access-personas">
          <button class="btn btn-primary" onclick="accessMainPage()">Voltar para Personas</button>
        </div>
      </div>
      
      <div class="main-content col-md-9">
        <!-- Seção de geração de imagem -->
        <div class="image-generator mt-3">
          <h5>Gerar Imagem com Stable Diffusion</h5>
          <input type="text" id="imagePrompt" class="form-control" placeholder="Digite o prompt para gerar a imagem" />
          <button class="btn btn-primary mt-2" onclick="generateImage()">Gerar Imagem</button>
          <div id="generatedImage" class="mt-3"></div> <!-- Aqui será exibida a imagem gerada -->
        </div>
      </div>
    </div>
  </div>

  <script>
    function accessMainPage() {
      window.location.href = '/personas.html'; // Redireciona para a página principal de personas
    }

    // Função para obter o token CSRF dos cookies
    function getCSRFToken() {
      const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('XSRF-TOKEN='));
      return csrfCookie ? csrfCookie.split('=')[1] : '';
    }

    async function generateImage() {
      const prompt = document.getElementById('imagePrompt').value.trim();
      if (!prompt) {
        alert('Por favor, insira um prompt para gerar a imagem.');
        return;
      }

      const csrfToken = getCSRFToken(); // Obtém o token CSRF dos cookies

      try {
        // Fazendo a chamada ao backend para gerar imagem
        const response = await fetch('/generate-image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': csrfToken, // Inclui o token CSRF no cabeçalho
          },
          body: JSON.stringify({ prompt }),
        });

        if (!response.ok) {
          const errorMessage = await response.json();
          alert(`Erro ao gerar a imagem: ${errorMessage.message}`);
          return;
        }

        const data = await response.json();
        const imageUrl = data.imageUrl;

        // Adiciona um timestamp para evitar problemas de cache
        const timestamp = new Date().getTime();
        const fullImageUrl = `${imageUrl}?timestamp=${timestamp}`;

        // Atualiza a div para exibir a imagem gerada
        document.getElementById('generatedImage').innerHTML = `<img src="${fullImageUrl}" alt="Imagem gerada" class="img-fluid"/>`;

      } catch (error) {
        console.error('Erro ao gerar imagem:', error);
        alert('Erro ao gerar imagem. Por favor, tente novamente.');
      }
    }

    window.onload = () => {
      // Carrega o nome do usuário logado ao carregar a página
      fetch('/get-logged-user')
        .then(response => {
          if (response.status === 401) {
            window.location.href = '/'; 
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('username').innerText = data.username || 'Desconhecido';
        })
        .catch(error => {
          console.error('Erro ao carregar o nome do usuário:', error);
          document.getElementById('username').innerText = 'Erro';
        });
    };
  </script>
</body>
</html>
